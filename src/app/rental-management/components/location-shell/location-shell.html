<div class="location-shell-container">
  <!-- Header -->
  <mat-toolbar color="primary" class="header">
    <button mat-icon-button routerLink="/">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="title">{{ formTitle }}</span>
    <span class="spacer"></span>

    <!-- Save State Chip -->
    <mat-chip-listbox class="save-state-chip">
      @if (saveState === 'draft') {
        <mat-chip-option color="accent" selected>
          <mat-icon matChipAvatar>save</mat-icon> Draft Saved
        </mat-chip-option>
      }
      @if (saveState === 'published') {
        <mat-chip-option color="primary" selected>
          <mat-icon matChipAvatar>check_circle</mat-icon> Published
        </mat-chip-option>
      }
      @if (saveState === 'unsaved') {
        <mat-chip-option color="warn" selected>
          <mat-icon matChipAvatar>warning</mat-icon> Unsaved Changes
        </mat-chip-option>
      }
      @if (saveState === 'error') {
        <mat-chip-option color="warn" selected>
          <mat-icon matChipAvatar>error</mat-icon> Error
        </mat-chip-option>
      }
    </mat-chip-listbox>

    <button mat-button (click)="saveDraft()" [disabled]="loading">Save Draft</button>
    <button mat-button (click)="preview()" [disabled]="loading">Preview</button>
    <button mat-raised-button color="accent" (click)="publish()" [disabled]="!rentalForm.valid || loading">
      @if (loading) {
        <mat-icon class="spinner-icon">
          <mat-progress-spinner diameter="20" mode="indeterminate" color="primary"></mat-progress-spinner>
        </mat-icon>
      }
      Publish
    </button>
  </mat-toolbar>

  <!-- Main Content with Stepper -->
  <div class="content">
    <mat-card class="stepper-card">
      <mat-stepper #stepper [linear]="false" [orientation]="stepperOrientation">
        <!-- Step 1: General Info -->
        <mat-step label="General Info" [stepControl]="rentalForm">
          <ng-template matStepContent>
            <app-rental-form
              [formGroup]="rentalForm"
              [rentalId]="rentalId"
              (formReady)="onRentalFormReady($event)"
              (filesSelected)="onFilesSelected($event)"
              (photoDeleted)="onPhotoDeleted($event)"
            ></app-rental-form>
            <div class="stepper-actions">
              <button mat-button matStepperNext [disabled]="!rentalForm.get('title')?.valid || !rentalForm.get('description')?.valid || !rentalForm.get('locationType')?.valid || !rentalForm.get('capacity')?.valid || !rentalForm.get('bedrooms')?.valid || !rentalForm.get('beds')?.valid || !rentalForm.get('bathrooms')?.valid || loading">Next</button>
            </div>
          </ng-template>
        </mat-step>

        <!-- Step 2: Address & Map -->
        <mat-step label="Address & Map" [stepControl]="addressFormGroup">
          <ng-template matStepContent>
            <app-rental-form
              [formGroup]="rentalForm"
              [rentalId]="rentalId"
              (formReady)="onRentalFormReady($event)"
              (filesSelected)="onFilesSelected($event)"
              (photoDeleted)="onPhotoDeleted($event)"
            ></app-rental-form>
            <div class="stepper-actions">
              <button mat-button matStepperPrevious [disabled]="loading">Back</button>
              <button mat-button matStepperNext [disabled]="!addressFormGroup.valid || loading">Next</button>
            </div>
          </ng-template>
        </mat-step>

        <!-- Step 3: Pricing & Availability -->
        <mat-step label="Pricing & Availability" [stepControl]="rentalForm">
          <ng-template matStepContent>
            <app-rental-form
              [formGroup]="rentalForm"
              [rentalId]="rentalId"
              (formReady)="onRentalFormReady($event)"
              (filesSelected)="onFilesSelected($event)"
              (photoDeleted)="onPhotoDeleted($event)"
            ></app-rental-form>
            <div class="stepper-actions">
              <button mat-button matStepperPrevious [disabled]="loading">Back</button>
              <button mat-button matStepperNext [disabled]="!rentalForm.get('basePrice')?.valid || !rentalForm.get('currency')?.valid || !rentalForm.get('availability')?.valid || loading">Next</button>
            </div>
          </ng-template>
        </mat-step>

        <!-- Step 4: Amenities & Photos -->
        <mat-step label="Amenities & Photos" [stepControl]="rentalForm">
          <ng-template matStepContent>
            <app-rental-form
              [formGroup]="rentalForm"
              [rentalId]="rentalId"
              (formReady)="onRentalFormReady($event)"
              (filesSelected)="onFilesSelected($event)"
              (photoDeleted)="onPhotoDeleted($event)"
            ></app-rental-form>
            <div class="stepper-actions">
              <button mat-button matStepperPrevious [disabled]="loading">Back</button>
              <button mat-button matStepperNext [disabled]="loading">Next</button>
            </div>
          </ng-template>
        </mat-step>

        <!-- Step 5: Rules & Publication -->
        <mat-step label="Rules & Publication" [stepControl]="bookingDetailsFormGroup">
          <ng-template matStepContent>
            <app-rental-form
              [formGroup]="rentalForm"
              [rentalId]="rentalId"
              (formReady)="onRentalFormReady($event)"
              (filesSelected)="onFilesSelected($event)"
              (photoDeleted)="onPhotoDeleted($event)"
            ></app-rental-form>
            <div class="stepper-actions">
              <button mat-button matStepperPrevious [disabled]="loading">Back</button>
              <button mat-raised-button color="primary" (click)="publish()" [disabled]="!rentalForm.valid || loading">
                @if (loading) {
                  <mat-icon class="spinner-icon">
                    <mat-progress-spinner diameter="20" mode="indeterminate" color="primary"></mat-progress-spinner>
                  </mat-icon>
                }
                Publish
              </button>
            </div>
          </ng-template>
        </mat-step>
      </mat-stepper>
    </mat-card>
  </div>

  <!-- Mobile Sticky Footer -->
  <div class="mobile-sticky-footer">
    <button mat-button (click)="stepper.previous()" [disabled]="stepper.selectedIndex === 0 || loading">Back</button>
    <button mat-raised-button color="primary" (click)="stepper.next()" [disabled]="stepper.selectedIndex === 4 || loading">Next</button>
  </div>
</div>
